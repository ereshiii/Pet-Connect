import{J as N,K as h,M as F,N as y,a as d}from"./vendor-BqPpK9Aj.js";import{u as C}from"./useToast-Dsd6g505.js";import{r as l,o as z}from"./vue-vendor-DmxhFomr.js";const p={apiKey:"AIzaSyAtAbLHeEzih0Jd7zOTAlWNIbtQbOfJV0o",authDomain:"petconnect-d88c7.firebaseapp.com",projectId:"petconnect-d88c7",storageBucket:"petconnect-d88c7.firebasestorage.app",messagingSenderId:"137614395456",appId:"1:137614395456:web:f94d99eb0d2e9da65cf7a5"},I="BCM3LConxlI3YvpgZtg6yrOSafqoXnrVmN6_cSQ_8GOCpBzCOpNJsqNXZqjQWoPmX1CYiO1fBLJdXmAhwULrmbY";let n=null,b=null;const g=()=>{try{return p.apiKey?(b=h(p),n=F(b),console.log("âœ… Firebase initialized successfully"),n):(console.warn("Firebase not configured - push notifications disabled"),null)}catch(i){return console.error("âŒ Firebase initialization error:",i),null}},v=async()=>{try{if(n||(n=g()),!n)throw new Error("Firebase messaging not initialized");if(!("serviceWorker"in navigator))throw new Error("Service workers not supported");if(await Notification.requestPermission()!=="granted")return console.warn("âŒ Notification permission denied"),null;console.log("âœ… Notification permission granted");const e=await navigator.serviceWorker.register("/firebase-messaging-sw.js");console.log("âœ… Service Worker registered:",e);const t=await N(n,{vapidKey:I,serviceWorkerRegistration:e});return t?(console.log("âœ… FCM Token obtained:",t.substring(0,20)+"..."),await P(t),t):(console.warn("âš ï¸ No FCM token available"),null)}catch(i){return console.error("âŒ Error requesting notification permission:",i),null}},P=async i=>{try{const e={token:i,device_type:"web",browser:navigator.userAgent.match(/(Firefox|Chrome|Safari|Edge|Opera)/)?.[1]||"Unknown",platform:navigator.platform||"Unknown",device_name:`${navigator.userAgent.match(/(Firefox|Chrome|Safari|Edge|Opera)/)?.[1]||"Browser"} on ${navigator.platform||"Web"}`,capabilities:{vibration:"vibrate"in navigator,notification:"Notification"in window,serviceWorker:"serviceWorker"in navigator}},t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");await d.post("/api/device-tokens",e,{headers:{"X-CSRF-TOKEN":t||"",Accept:"application/json"}}),console.log("âœ… FCM token saved to backend")}catch(e){e.response?.status===401||e.response?.status===403||e.response?.status===404?(console.warn("âš ï¸ User not logged in - token not saved to database (this is okay for testing)"),console.log("ðŸ’¡ To save the token, login first then enable notifications")):console.error("âŒ Failed to save FCM token:",e)}},S=i=>(n||(n=g()),n?y(n,e=>{if(console.log("ðŸ“¬ Foreground message received:",e),e.notification){const{title:t,body:s,icon:a}=e.notification;new Notification(t||"PetConnect",{body:s||"",icon:a||"/icons/notification-icon.png",badge:"/icons/badge-icon.png",tag:e.data?.appointment_id||"general",requireInteraction:e.data?.requireInteraction==="true",data:e.data})}i(e)}):(console.warn("Cannot listen for messages - Firebase not initialized"),()=>{})),T=()=>"Notification"in window&&"serviceWorker"in navigator,W=()=>Notification.permission;function O(){const i=C(),e=l(T()),t=l(W()),s=l(!1),a=l(null),f=()=>{if(!e.value){console.warn("Push notifications not supported in this browser");return}try{g(),s.value=!0,S(o=>{if(console.log("ðŸ“¬ Notification received:",o),o.notification&&t.value==="granted"){const r=o.notification.title||"New Notification",u={body:o.notification.body||"",icon:"/favicon.ico",badge:"/favicon.ico",tag:o.messageId||"notification",requireInteraction:!1,data:o.data};try{const c=new Notification(r,u);console.log("âœ… Windows notification created:",c),c.onclick=()=>{window.focus(),c.close()}}catch(c){console.error("âŒ Failed to create notification:",c)}i.success(r)}}),console.log("âœ… Firebase notifications initialized")}catch(o){console.error("âŒ Failed to initialize Firebase:",o)}},m=async()=>{if(!e.value)return i.error("Push notifications are not supported in your browser"),!1;s.value||f();try{const o=Notification.permission;if(console.log("Current notification permission:",o),o==="denied")return i.error("Notifications are blocked. Please enable them in your browser settings."),!1;const r=await v();return r?(a.value=r,t.value="granted",i.success("Notifications enabled successfully"),!0):(t.value=Notification.permission,t.value==="denied"?i.error("Notifications blocked. Please enable them in your browser settings."):i.error("Failed to get notification token. Please try again."),!1)}catch(o){return console.error("Failed to enable notifications:",o),i.error("Failed to enable notifications. Please try again."),!1}},w=()=>t.value==="granted",k=async()=>{if(!a.value)return i.error("No active notification token found"),!1;try{const o=await d.get("/api/device-tokens");if(o.data&&o.data.data){const r=o.data.data.find(u=>u.is_active);if(r)return await d.patch(`/api/device-tokens/${r.id}`,{is_active:!1}),a.value=null,i.success("Notifications disabled successfully"),!0}return!1}catch(o){return console.error("Failed to disable notifications:",o),i.error("Failed to disable notifications. Please try again."),!1}};return z(()=>{f(),t.value==="granted"&&v()}),{isSupported:e,permission:t,isInitialized:s,fcmToken:a,initialize:f,enableNotifications:m,disableNotifications:k,areNotificationsEnabled:w}}export{O as u};
